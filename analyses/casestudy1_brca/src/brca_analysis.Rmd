---
title: "Case study 1: Breast cancer"
author: "Amrit Singh"
date: '2017-09-20'
output:
  pdf_document:
    toc: yes
  html_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, tidy = TRUE, cache = TRUE)

WhereAmI <- "~/Dropbox/Manuscript/diablo/analyses/casestudy1_brca/"

## load libraries
library(cowplot)
library(tidyverse)
library(mixOmics)
library(amritr)
library(corrplot)
require(parallel)
library(sear)
library(UpSetR)
library(venn)

## load data
load(paste0(WhereAmI, "data/trainTestDatasetsNormalized.RDATA"))
```

\pagebreak

# Number of samples and variables per dataset

```{r}
Y.train <- droplevels(pam50Train0$Call)
names(Y.train) <- rownames(pam50Train0)
table(Y.train)
X.train <- list(mRNA = mrnaTrain0, miRNA = mirnaTrain0, CpGs = methTrain0, Proteins = protTrain0)
all(names(Y.train) == rownames(X.train[[1]]))
all(names(Y.train) == rownames(X.train[[2]]))
all(names(Y.train) == rownames(X.train[[3]]))
all(names(Y.train) == rownames(X.train[[4]]))
sapply(X.train, dim)
```

# Tune DIABLO model

```{r}
## design matrix
design <- matrix(1, nrow = length(X.train), ncol = length(X.train))
rownames(design) <- colnames(design) <- names(X.train)
diag(design) <- 0
test.keepX = list(mRNA = c(5, 10, 15, 20), miRNA = c(5, 10, 15, 20), CpGs = c(5, 10, 15, 20), Proteins = c(5, 10, 15, 20))

#t1 <- proc.time()
#tune = tune.block.splsda(X = X.train, Y = Y.train, ncomp = 3, test.keepX = test.keepX, dist = "centroids.dist",
#                          design = design, validation = "Mfold", folds = 5, nrepeat = 5, cpus = 5)
#t2 <- proc.time()
#(t2-t1)/60 # 77.3640000 minutes
#saveRDS(tune, "~/Dropbox/Manuscript/mixOmics_org_DIABLO/casestudy_brca/data/brcaPanel_tune.rds")

tune <- readRDS(paste0(WhereAmI, "data/brcaPanel_tune.rds"))
```

## Component 1

```{r}
p1 <- data.frame(mean = tune$error.rate[, "comp1"], sd = tune$error.rate.sd[, "comp1"]) %>% 
  as.data.frame %>% 
  mutate(keep = rownames(.)) %>% 
  arrange(mean) %>% 
  mutate(keep = factor(keep, keep), Comp = "Component 1") %>% 
  slice(1:50) %>% 
  ggplot(aes(y = keep, x = mean)) +
  geom_point() +
  geom_errorbarh(aes(xmin = mean-sd,  xmax = mean+sd)) +
  customTheme(sizeStripFont = 25, xAngle = 0, hjust = 0.5, vjust = 0.5, xSize = 15, 
              ySize = 15, xAxisSize = 15, yAxisSize = 15) +
  xlab("Mean±SD Error rate \n (5 x 5-fold cross-validation)") +
  ylab("Number of features per dataset (mRNA_miRNA_CpGs_Proteins) \n top 50 keepX with the minimum error rate for component 1") +
  facet_wrap(~Comp) +
  annotate("text", label = "minError = 31.5% \n (20_15_10_20)", x = 0.38, y = 0.75, size = 5) +
  xlim(c(0.28,0.4))

```

## Component 2

```{r}
p2 <- data.frame(mean = tune$error.rate[, "comp2"], sd = tune$error.rate.sd[, "comp2"]) %>% 
  as.data.frame %>% 
  mutate(keep = rownames(.)) %>% 
  arrange(mean) %>% 
  mutate(keep = factor(keep, keep), Comp = "Component 2") %>% 
  slice(1:50) %>% 
  ggplot(aes(y = keep, x = mean)) +
  geom_point() +
  geom_errorbarh(aes(xmin = mean-sd,  xmax = mean+sd)) +
  customTheme(sizeStripFont = 25, xAngle = 0, hjust = 0.5, vjust = 0.5, xSize = 15, 
              ySize = 15, xAxisSize = 15, yAxisSize = 15) +
  xlab("Mean±SD Error rate \n (5 x 5-fold cross-validation)") +
  ylab("Number of features per dataset (mRNA_miRNA_CpGs_Proteins) \n top 50 keepX with the minimum error rate for component 2") +
  facet_wrap(~Comp) +
  annotate("text", label = "minError = 21.9% \n (20_15_10_20)", x = 0.3, y = 0.75, size = 5) +
  xlim(c(0.16,0.4))
```

## Component 3

```{r}
p3 <- data.frame(mean = tune$error.rate[, "comp3"], sd = tune$error.rate.sd[, "comp3"]) %>% 
  as.data.frame %>% 
  mutate(keep = rownames(.)) %>% 
  arrange(mean) %>% 
  mutate(keep = factor(keep, keep), Comp = "Component 3") %>% 
  slice(1:50) %>% 
  ggplot(aes(y = keep, x = mean)) +
  geom_point() +
  geom_errorbarh(aes(xmin = mean-sd,  xmax = mean+sd)) +
  customTheme(sizeStripFont = 25, xAngle = 0, hjust = 0.5, vjust = 0.5, xSize = 15, 
              ySize = 15, xAxisSize = 15, yAxisSize = 15) +
  xlab("Mean±SD Error rate \n (5 x 5-fold cross-validation)") +
  ylab("Number of features per dataset (mRNA_miRNA_CpGs_Proteins) \n top 50 keepX with the minimum error rate for component 3") +
  facet_wrap(~Comp) +
  annotate("text", label = "minError = 17.9% \n (20_15_10_20)", x = 0.25, y = 0.75, size = 5) +
  xlim(c(0.15,0.3))

pdf(paste0(WhereAmI, "results/Figures/optimal_errorRate_tuneFunction_mixOmics_comp1.pdf"), height = 10, width = 20)
plot_grid(p1, p2, p3, ncol = 3)
dev.off()

```

## Optimal DIABLO model

```{r}
all(rownames(tune$error.rate) == rownames(tune$error.rate.sd))
data.frame(keepX = rep(rownames(tune$error.rate), 3), 
  meanError = as.numeric(tune$error.rate), 
  sdError = as.numeric(tune$error.rate.sd),
  comp = rep(paste0("comp", 1:3), each=nrow(tune$error.rate))) %>% 
  group_by(comp) %>% 
  filter(meanError == min(meanError))
```

## optimal keepX

```{r}
tune$choice.keepX
```


# DIABLO-supervised

```{r}
ncomp <- 3
keepX = tune$choice.keepX

diablo = block.splsda(X = X.train, Y = Y.train, ncomp = ncomp, keepX = keepX, design = design)
```

# Number of variables of each omic-type in the diablo panel

```{r}
diabloPanel <- mapply(function(x, y, z){
  c(x, y, z)
}, x = lapply(selectVar(diablo, comp = 1)[-5], function(i) unlist(i[[1]])),
   y = lapply(selectVar(diablo, comp = 2)[-5], function(i) unlist(i[[1]])),
   z = lapply(selectVar(diablo, comp = 3)[-5], function(i) unlist(i[[1]])))
sapply(diabloPanel, length)
```

## plot features

```{r}
lapply(selectVar(diablo)[1:4], function(i){i$value}) %>% 
  do.call(rbind, .) %>% 
  data.frame() %>% 
  mutate(dataset = sapply(strsplit(rownames(.), "\\."), function(i) i[1]),
         feature = sapply(strsplit(rownames(.), "\\."), function(i) i[2]),
         value.var = abs(value.var)) %>% 
  group_by(dataset) %>% 
  arrange(desc(value.var)) %>% 
  mutate(feature = factor(as.character(feature), feature)) %>% 
  ggplot(aes(x = feature, y = value.var, fill = dataset, color = dataset)) +
  geom_bar(stat = "identity")


```





# Pathway enrichment

```{r, fig.height=7, fig.width=10}
mrna <- unique(c(diabloPanel$mRNA, diabloPanel$CpGs, diabloPanel$Proteins)) %>% 
  strsplit(., ";") %>% 
  unlist %>% 
  strsplit(., " ") %>% 
  unlist

enrichment <- sear(mrna, "mrna") %>% 
    group_by(collection, subcollection) %>% 
    filter(fdr < 0.05) %>% 
  rowwise() %>% 
  mutate(mrna = length(unique(intersect(members, diabloPanel$mRNA))),
         cpg = length(unique(intersect(members, diabloPanel$CpGs))),
         protein = length(unique(intersect(members, diabloPanel$Proteins)))) %>% 
  dplyr::select(collection, subcollection, mrna:protein) %>% 
  filter(collection != "ARCHIVED")

geneset <- enrichment %>% 
  gather(dataset, n_sig, mrna:protein) %>% 
  group_by(collection, subcollection) %>% 
  summarise(total = sum(n_sig))

p <- lapply(unique(geneset$collection), function(i){
  geneset %>% 
  filter(collection == i) %>% 
  ggplot(aes(x = collection, y = total, fill = subcollection)) +
  geom_bar(stat = "identity") +
  facet_wrap(~collection)
})
names(p) <- unique(geneset$collection)

plot_grid(p$BTM, p$C2, p$C3, p$C4, p$C5, p$C6, p$C7, p$H, p$TISSUES, nrow = 2, ncol = 5)


```


enrichment0 <- sear(mrna, "mrna") %>% 
    group_by(collection, subcollection) %>% 
    filter(fdr < 0.05)
enrichment <- enrichment0 %>% 
  rowwise() %>% 
  mutate(mrna = length(unique(intersect(members, diabloPanel$mRNA))),
         cpg = length(unique(intersect(members, diabloPanel$CpGs))),
         protein = length(unique(intersect(members, diabloPanel$Proteins)))) %>% 
  dplyr::select(collection, subcollection, mrna:protein) %>% 
  filter(collection != "ARCHIVED")
  
n_sigAll0 <- enrichment %>% 
  group_by(collection, subcollection) %>% 
  dplyr::summarise(n = n()) %>% 
  filter(collection != "ARCHIVED")
n_sigAll <- as.matrix(n_sigAll0[, -1])
rownames(n_sigAll) <- n_sigAll0$collection

n_sigSingle0 <- enrichment %>% 
  dplyr::group_by(collection) %>% 
  dplyr::summarise(mrna = sum(mrna),
                   cpg = sum(cpg),
                   protein = sum(protein)) %>% 
  filter(collection != "ARCHIVED")
n_sigSingle <- as.matrix(n_sigSingle0[, -1])
rownames(n_sigSingle) <- n_sigSingle0$collection
all(rownames(n_sigAll) == rownames(n_sigSingle))
genesetResults <- scale(t(n_sigSingle), center = FALSE, scale = rowSums(n_sigSingle)) * t(cbind(n_sigAll, n_sigAll, n_sigAll))

genesetResults %>% 
  as.data.frame() %>% 
  mutate(omic = rownames(.)) %>% 
  gather(collection, prop, -omic) %>% 
  #mutate(collection = factor(collection, c("C1","C3","C6","C7","TISSUES","C4","C2","H","C5","BTM"))) %>% 
  ggplot(aes(x = collection, y = prop, fill = omic, color = omic)) +
  geom_bar(stat = "identity") +
  facet_wrap(~collection, scales = "free", ncol = 5) +
  customTheme(sizeStripFont = 20, xAngle = 0, hjust = 0.5, vjust = 0.5, xSize = 15, 
              ySize = 15, xAxisSize = 15, yAxisSize = 15) +
  ylab("Number of significant gene sets (FDR < 5%")

```

\pagebreak

# Which features are related to breast cancer?
  * obtained Breast cancer related genes from four sources:
  1) DriverDBv2 (under the cancer tab; tissue: breast cancer, dataset: breast_invasive_carcinoma (TCGA, US))
  2) MolSigDB
  3) Jensen Diseases (Enrichr)
  4) OMIM (Enrichr)

```{r}
driverdbv2 <- read.delim(paste0(WhereAmI, "results/breastCancer_relatedGenes/driverdbv2.txt"), header = FALSE) %>% 
  as.matrix %>% 
  as.character()
molsigdb <- 

molsigdb <- filter(collections, geneset %in% enrichment0$geneset[enrichment0$geneset %in% grep("BREAST", collections$geneset, value = TRUE)])$members_mrna %>% 
  unlist %>% unique

jensen0 <- read.csv(paste0(WhereAmI, "results/breastCancer_relatedGenes/Jensen_DISEASES.csv"), header = FALSE)
jensen <- apply(jensen0[, -1], 1, function(i){
    x <- as.character(as.matrix(i))[as.character(as.matrix(i)) != ""]
    x[!is.na(x)]
  })
names(jensen) <- as.character(jensen0[,1])
jensen <- jensen[grep("breast", names(jensen), value = TRUE)] %>% 
  unlist %>% unique

omim0 <- read.delim(paste0(WhereAmI, "results/breastCancer_relatedGenes/OMIM_Disease.txt"), header = FALSE)
omim <- apply(omim0[, -1], 1, function(i){
    x <- as.character(as.matrix(i))[as.character(as.matrix(i)) != ""]
    x[!is.na(x)]
  })
names(omim) <- as.character(omim0[,1])
omim <- omim[grep("breast", names(omim), value = TRUE)] %>% 
  unlist %>% unique

brca_genes = list(DIABLO = unlist(unlist(diabloPanel)),
                  MolSigDB = molsigdb,
                  DriverDBv2 = driverdbv2,
                  OMIM = omim)
venn(brca_genes, ilab=TRUE, zcolor = "style")

```

## types of omic variables in the overlap

```{r}
mirsInput <- fromList(brca_genes)
upset(mirsInput, sets = colnames(mirsInput), sets.bar.color = "#56B4E9",
    queries = list(list(query = intersects, params = list("DIABLO"), active = TRUE, color = "blue")))
```



## Connectivity

```{r}
cutoff <- 0.5

combinedDat <- mapply(function(x, y){
  x[, y]
}, x = X.train, y = diabloPanel) %>% 
  do.call(cbind, .)
## generate network object
adjMat0 = cor(combinedDat)
adjMat <- adjMat0
adjMat[abs(adjMat) < cutoff] <- 0
adjMat[abs(adjMat) > cutoff] <- 1
netStat <- networkStats(adjMat = adjMat, mode = "graph", maxlen = 6)

```

## Network

```{r}
col <- brewer.pal(n = length(X.train), name = "Set1")
nodeCol = rep(col, sapply(diabloPanel, length))
## plot network
nrelations <- network::network(adjMat, directed=FALSE)
gplot(nrelations, usearrows=FALSE, vertex.col = nodeCol, pch = 19)
legend("topleft", names(X.train), col = col, pch = 19, bty = "n")

```

# Plot samples plots for the supervised and unsupervised DIABLO analyses

# Supervised
  * R^2 for comp1 and comp2

```{r}
df.super <- as.data.frame(Reduce("+", diablo$variates[-length(diablo$variates)])[,1:2]/length(X.train))
df.super$Analysis <- "DIABLO"
df.super$Pheno <- Y.train

# proportion of variation explained
summary(lm(df.super$`comp 1` ~ df.super$Pheno))$r.squared
summary(lm(df.super$`comp 2` ~ df.super$Pheno))$r.squared

#pdf(paste0(WhereAmI, "Figures/diablo_supervised.pdf"), height = 4, width = 5)
df.super %>% 
  ggplot(aes(`comp 1`, `comp 2`, group = Pheno, color = Pheno)) + geom_point() +
  facet_wrap(~Analysis) + stat_ellipse() +
  customTheme(sizeStripFont = 15, xAngle = 0, hjust = 0.5, 
              vjust = 0.5, xSize = 10, ySize = 10, xAxisSize = 10, yAxisSize = 10) +
  xlab(expression("Consensus component 1")) + 
  ylab(expression("Consensus component 2"))
#dev.off()
```

## Evaulate performance in test dataset

```{r}
## Training data
Y.train <- droplevels(pam50Train0$Call)
names(Y.train) <- rownames(pam50Train0)
table(Y.train)
X.train <- list(mRNA = mrnaTrain0, miRNA = mirnaTrain0, CpGs = methTrain0, Proteins = protTrain0)
all(names(Y.train) == rownames(X.train[[1]]))
all(names(Y.train) == rownames(X.train[[2]]))
all(names(Y.train) == rownames(X.train[[3]]))
all(names(Y.train) == rownames(X.train[[4]]))
dim(X.train[[1]]); dim(X.train[[2]]); dim(X.train[[3]]); dim(X.train[[4]]);
## Test data
Y.test <- droplevels(pam50Test0$Call)
names(Y.test) <- rownames(pam50Test0)
table(Y.test)
length(c(Y.train, Y.test))
X.test <- list(mRNA = mrnaTest0, miRNA = mirnaTest0, CpGs = methTest0)
all(names(Y.test) == rownames(X.test[[1]]))
all(names(Y.test) == rownames(X.test[[2]]))
all(names(Y.test) == rownames(X.test[[3]]))
dim(X.test[[1]]); dim(X.test[[2]]); dim(X.test[[3]]); 

## build diablo model and test on independent dataset
pred <- predict(diablo, X.test, dist = "all")

TestError <- apply(pred$WeightedVote$centroids.dist, 2, function(y) {
      y[is.na(y)] <- nlevels(Y.test) + 5
      temp = table(factor(y, levels = c(levels(Y.test), 
        nlevels(Y.test) + 5)), Y.test)
      diag(temp) <- 0
      err = c(colSums(temp)/summary(Y.test), sum(temp)/length(Y.test), 
        mean(colSums(temp)/summary(Y.test)))
      return(err = err)
    })
rownames(TestError) <- c(levels(Y.test), "Overall.ER", "Overall.BER")
```

# DIABLO (Sample plots)

```{r, fig.height=5, fig.width=13}
# model variates
varDat.train <- do.call(rbind, diablo$variates[1:length(X.train)]) %>% 
  as.data.frame %>% mutate(subj = rownames(.))
varDat.train$Dataset <- rep(names(X.train), e = length(Y.train))
varDat.train$Class <- Y.train
varDat.train <- varDat.train %>% group_by(Class, subj) %>% 
  summarise_all(funs(mean)) %>% 
  mutate(Dataset = "Consensus") %>% 
  dplyr::select(`comp 1`, `comp 2`, `comp 3`, subj, Dataset, Class) %>% 
  as.data.frame() %>% 
  rbind(., varDat.train) %>% 
  mutate(Dataset = factor(Dataset, c("Consensus", "mRNA", "miRNA", "CpGs", "Proteins"))) 

# test variates
varDat.test <- do.call(rbind, pred$variates) %>% as.data.frame %>% mutate(subj = rownames(.))
varDat.test$Dataset <- rep(names(pred$variates), e = nrow(pred$variates[[1]]))
varDat.test$Class <- Y.test
colnames(varDat.train) <- colnames(varDat.test) <- c("comp 1", "comp 2", "comp 3", "subj", "Dataset", "Class")
varDat.test <- varDat.test %>% group_by(Class, subj) %>% 
  summarise_all(funs(mean)) %>% 
  mutate(Dataset = "Consensus") %>% 
  dplyr::select(`comp 1`, `comp 2`, `comp 3`, subj, Dataset, Class) %>% 
  as.data.frame() %>% 
  rbind(., varDat.test) %>% 
  mutate(Dataset = factor(Dataset, c("Consensus", "mRNA", "miRNA", "CpGs", "Proteins"))) 

#pdf(paste0(WhereAmI, "Figures/SamplePlots_trainEllipses_testPoints.pdf"), width = 14, height = 3.5)
p1 <- filter(varDat.test, Dataset == "Consensus") %>% 
  ggplot(aes(x = `comp 1`, y = `comp 2`, color = Class)) + 
  geom_point(size = 1) +
  facet_wrap(~Dataset, scales = "free", ncol = 5) + 
   stat_ellipse(data = filter(varDat.train, Dataset == "Consensus"), size = 1) +
  customTheme(sizeStripFont = 15, xAngle = 0.5, hjust = 0.5, vjust = 0.5,
              xSize = 10, ySize = 10, xAxisSize = 10, yAxisSize = 10) +
  xlab("Component 1") + ylab("Component 2") +
  theme(legend.position = "none")
#dev.off()

p2 <- filter(varDat.test, Dataset != "Consensus") %>% 
  ggplot(aes(x = `comp 1`, y = `comp 2`, color = Class)) + 
  geom_point(size = 1) +
  facet_wrap(~Dataset, scales = "free", ncol = 2) + 
   stat_ellipse(data = filter(varDat.train, Dataset != "Consensus"), size = 1) +
  customTheme(sizeStripFont = 15, xAngle = 0.5, hjust = 0.5, vjust = 0.5,
              xSize = 10, ySize = 10, xAxisSize = 10, yAxisSize = 10) +
  xlab("Component 1") + ylab("Component 2")

#pdf(paste0(WhereAmI, "Figures/SamplePlots_trainEllipses_testPoints.pdf"), height = 5, width = 10)
multiplot(p1, p2, cols=2, layout=NULL) 
#dev.off()



```

## Correlation between components

```{r}
#pdf(paste0(WhereAmI, "Figures/SamplePlots.pdf"))
plotIndiv(diablo, ellipse = TRUE, ellipse.level = 0.68, star = F, ind.names = FALSE)
#dev.off()

#pdf(paste0(WhereAmI, "Figures/splomPlots.pdf"))
plotDiablo(diablo)
#dev.off()
```

## heatmap

```{r, fig.height=10, fig.width=9}
#pdf(paste0(WhereAmI, "Figures/heatmap.pdf"))
cimDiablo(diablo)
#dev.off()
```

# Circos plot

```{r}
#pdf(paste0(WhereAmI, "Figures/circosPlot.pdf"))
#circosPlot(diablo, cutoff = 0.7)
#dev.off()
```
