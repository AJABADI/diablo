---
title: "asthma_analysis"
bibliography: /Users/asingh/Dropbox/Manuscript/diablo/mybib.bib
thanks: "Replication files are available at https://github.com/singha53/diablo"
output:
  html_document:
    toc: yes
    theme: united
    highlight: tango
    keep_md: yes
biblio-style: /Users/asingh/Dropbox/Manuscript/diablo/genome-biology.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, tidy = TRUE)

WhereAmI <- "/Users/asingh/Dropbox/Manuscript/diablo/analyses/casestudy2_asthma/"

# load libraries
library(corrplot)
library(pROC)
library(amritr)
library(tidyverse)
library(mixOmics)
library(NMF)

## load data
load(paste0(WhereAmI, "data/asthmaDatasets.RDATA"))
## clean datasets
cells <- cells[, c("Relative.Neutrophils","Relative.Lymphocytes","Relative.Monocytes",
  "Relative.Eosinophils","Relative.Basophils","Treg","Tcells","Bcells","Th17")]
metExp <- metExp[apply(metExp, 1, mad) >0, ]
rownames(metExp) <- metabolites[rownames(metExp), "BIOCHEMICAL"]
```

\pagebreak

# FEV1 profiles

```{r}
fev1 <- read.csv(paste0(WhereAmI, "data/fev1Data.csv"), row.names = 1)[, c("BLFEV","F10L","F20L","F30L","F45L","F60L","F90L","F120L","F180L","F240L","F300L","F360L","F420L")]

p <- scale(t(fev1), center = fev1$BLFEV, scale = fev1$BLFEV) %>% as.data.frame() %>%
  tbl_df() %>%
  mutate(Time = c(0, 10, 20, 30, 45, 60, 90, 120, 180 ,240, 300, 360, 420)) %>%
  tidyr::gather(Subject, FEV1, -Time) %>%
  filter(Time %in% c(0, 10, 20, 30, 45, 60, 90, 120)) %>%
  mutate(fev1 = 100*FEV1) %>%
  ggplot(aes(x = Time, y = fev1, fill = Subject, color = Subject)) +
  geom_point() + geom_line(color="black")
  
#pdf(paste0(WhereAmI, "7-Figure6_asthmaAnalysis/Figure6A.pdf"))
p + scale_y_continuous(expression('Percent drop in '~ FEV[1])) + theme_bw() +
  scale_x_continuous(expression('Time (minutes)')) +
  theme(axis.text.y = element_text(size = 15, hjust = 1)) + theme(axis.text.x = element_text(size = 15, hjust = 0.5))+
  theme(axis.title.x=element_text(size = 15)) + theme(axis.title.y=element_text(size = 15,angle = 90))+ 
  theme(legend.key = element_rect(colour = "black", fill="white"))  +
  theme(plot.background = element_rect()) +  
  theme(strip.background = element_rect(colour = "black", fill = "white",
                                        size = 1), strip.text.x = element_text(size=20)) +
  geom_hline(yintercept = 0, colour="yellow3", linetype = "longdash") +
  theme(legend.position="none")
#dev.off()
```

# DIABLO

## tune keepX

```{r, fig.height=10}
X <- list(cells=cells, gene.module=gene.module, metabolite.module=metabolite.module)
time <- demo$Time
Cov <- data.frame(sample = rep(1:14, 2), stimul = time)
A = lapply(X, function(i) suppressMessages(withinVariation(X = i, design = Cov)))

## run DIABLO
ncomp <- 2
design <- matrix(1, nrow = 3, ncol = 3)
diag(design) <- 0

#test.keepX = list(Cells = 1:5, geneMods = 3:10, metMods = 3:10)
#t1 <- proc.time()
#tune.diablo_paired = tune.block.splsda(X = A, Y = time, ncomp = ncomp, test.keepX = test.keepX, 
#                          dist = "centroids.dist",
#                          design = design, validation = "loo")
#t2 <- proc.time()
#(t2-t1)/60 # 6.3 minutes
#saveRDS(tune.diablo_paired, paste0(WhereAmI, "results/tune.diablo_paired.rds"))

tune.diablo_paired <- readRDS(paste0(WhereAmI, "results/tune.diablo_paired.rds"))
plot(tune.diablo_paired)
tune.diablo_paired$choice.keepX
tune.diablo_paired$error.rate %>% 
  as.data.frame() %>% 
  mutate(keepX = rownames(.)) %>% 
  gather(comp, error, -keepX) %>% 
  group_by(comp) %>% 
  filter(error == min(error)) %>% 
  slice(1)
```

## error rate of optimal keepX
```{r}
diablo_paired = block.splsda(X = A, Y = time, ncomp = ncomp,
                            keepX = tune.diablo_paired$choice.keepX, design = design)
diablo_pairedPanel <- list(cells = list(comp1=selectVar(diablo_paired, comp = 1)$cells$name, comp2=selectVar(diablo_paired, comp = 2)$cells$name),
  gene.module = list(comp1=selectVar(diablo_paired, comp = 1)$gene.module$name, comp2=selectVar(diablo_paired, comp = 2)$gene.module$name),
  metabolite.module = list(comp1=selectVar(diablo_paired, comp = 1)$metabolite.module$name, comp2=selectVar(diablo_paired, comp = 2)$metabolite.module$name))

perf=perf(diablo_paired, validation="loo")
perf$WeightedVote.error.rate
```

## AUC

```{r}
time <- relevel(demo$Time, ref = "pre")
names(time) <- rownames(demo)
predictScores <- lapply(perf$predict$nrep1 %>% amritr::zip_nPure(), function(i){
  Reduce("+", i)/length(i)
})
all(rownames(predictScores) == names(time))

roc.score = roc(response = as.character(time), predictor = predictScores$`comp 2`[, "post"], plot = TRUE, percent = TRUE, na.rm =TRUE)
roc.res = data.frame(Specificity = rev(roc.score$specificities), Sensitivity = rev(roc.score$sensitivities))
roc.res$Specificity = 100 - as.numeric(roc.res$Specificity)
roc.res$Sensitivity = as.numeric(roc.res$Sensitivity)
roc.score$auc
```

# Component plots

```{r}
as.data.frame(Reduce("+", diablo_paired$variates)/length(X)) %>% 
  mutate(time = time) %>% 
  ggplot(aes(x = `comp 1`, y = `comp 2`, group = time, color = time)) +
  geom_point(size = 4) +
  stat_ellipse() +
  customTheme(sizeStripFont = 15, xAngle = 0, hjust = 0.5, vjust = 0.5, 
              xSize = 10, ySize = 10, xAxisSize = 10, yAxisSize = 10) +
  xlab("Consensus Component 1") +
  ylab("Consensus Component 2")

```

# heatmap

```{r, fig.height=10}
cimDiablo(diablo_paired, margins = c(25, 5), comp = 1)
```

> the above heatmap shows cells as an individula feature name

```{r, fig.height=10}
comp <- rep(sapply(strsplit(names(rapply(diablo_pairedPanel, length)), "\\."), function(i) i[length(i)]),
  rapply(diablo_pairedPanel, length))
X <- as.data.frame(do.call(cbind, A))[, unlist(diablo_pairedPanel)]
X <- scale(X)
X[which(X < -2)] <- -2
X[which(X > 2)] <- 2
aheatmap(X, annCol = list(comp=comp), annRow = list(time=time, response=demo$Response))

```


# Circos plot

>Error in `row.names<-.data.frame`(`*tmp*`, value = value) : invalid 'row.names' length

```{r, fig.height=7, fig.width=7}
#circosPlot(diablo_paired, cutoff = 0.7)
```

## network

```{r}
library(annotate)
library("hugene10sttranscriptcluster.db")

cells_asthma <- cells[, unlist(diablo_pairedPanel$cells)]
genes_asthma <- subset(genDat, Mod %in%  as.character(unlist(diablo_pairedPanel$gene.module))) %>% 
  mutate(genSym = getSYMBOL(sapply(strsplit(rownames(.), "\\."), function(i) i[1]), "hugene10sttranscriptcluster"))
genes_mapper <- split(as.character(genes_asthma$genSym), genes_asthma$Mod)
genes_asthma <- genes_asthma %>% 
  dplyr::select(-Mod) %>% 
  dplyr::group_by(genSym) %>% 
  dplyr::slice(1) %>% 
  as.data.frame()
metabolties_asthma <- metabolites[metabolites$SUB_PATHWAY %in% unlist(diablo_pairedPanel$metabolite.module), ]
rownames(metabolties_asthma) <- metabolties_asthma$BIOCHEMICAL

cells_mapper <- list(Monocytes = "Relative.Monocytes", Lymphocytes = "Relative.Lymphocytes")
metabolties_mapper <- split(as.character(metabolties_asthma$BIOCHEMICAL), factor(as.character(metabolties_asthma$SUB_PATHWAY)))

cellsExp <- A$cells[, unlist(cells_mapper)]
genesExp0 <- subset(genes_asthma, genSym %in% unique(unlist(genes_mapper)))
genesExp <- as.matrix(genesExp0[, -ncol(genesExp0)])
rownames(genesExp) <- genesExp0$genSym


```

